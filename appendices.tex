\appendix
\section{Code Samples}

\subsection{A Hello, Word Program in C}

\begin{listing}[H]
  \caption{Pseudocode showing what happens when a syscall is
  made}\label{lst:hello-world}
  \begin{minted}[fontsize=\small, frame=single, linenos]{c}
  #include <stdio.h>

  int main() {
    // printf calls write() behind the scenes;
    // write() will call the `syscall` x86 instruction 
    // (perhaps via some wrapper functions...)
    printf("Hello, World!");

    return 0;
  }
 \end{minted}
\end{listing}



\subsection{Pseudocode for \af Core Logic}\label{subsec:apx-af-pseudocode}

\begin{listing}[H]
  \caption{Pseudocode showing what happens when a syscall is made}\label{lst:syscall-filter}
  \begin{minted}[fontsize=\small, frame=single, linenos]{c}
  on every syscall {
      // only filter syscalls made from filter app or its children
      pid, ppid = get_pid(), get_ppid()

      if (pid not in filter_map and ppid not in filter_map) {
          return 0;
      }

      // protect forks of protected processes
      if (pid not in filter_map) {
          insert(filter_map, pid)
      }

      syscall_nr = get_syscall_num()

      // unwind the stack to find the first non-libc return pointer
      rp = find_syscall_site()

      // find which shared library the rp points to
      calling_so = lookup_vma_file(rp)
      whitelist = get_whitelist(calling_so)

      if syscall_nr not in whitelist {
          // intervene based on user configuration
          intervene()
      }

      // otherwise, success!
      return 0;
  }
  \end{minted}
\end{listing}

\subsection{Pseudocode for Whitelist Generation}\label{subsec:apx-wlgen-pseudocde}

\begin{listing}[H]
  \caption{Pseudocode showing how dynamic analysis based whitelist generation is
  implemented}\label{lst:generator-pseudocode}
  \begin{minted}[fontsize=\small, frame=single, linenos]{c}
  on every syscall {
      // only filter syscalls made from filter app or its children
      pid, ppid = get_pid(), get_ppid()

      if (pid not in filter_map and ppid not in filter_map) {
          return 0;
      }

      // protect forks of protected processes
      if (pid not in filter_map) {
          insert(filter_map, pid)
      }

      syscall_nr = get_syscall_num()

      // unwind the stack to find the first non-libc return pointer
      rp = find_syscall_site()

      // find which shared library the rp points to
      calling_so = lookup_vma_file(rp)

      // at this point, the generation code becomes different to addrfilter

      // create a new whitelist for the calling_so if it doesn't already exist
      if calling_so not in whitelist_map {
        insert_to_map(whitelist_map, calling_so, new(whitelist))
      }

      // write the syscall number into the calling_so's whitelist, and update
      // the map
      whitelist = get_whitelist(calling_so)
      write_to_whitelist(whitelist, syscall_nr)
      insert_to_map(whitelist_map, calling_so, whitelist)
        
      // success!
      return 0;
  }
  \end{minted}
\end{listing}



\subsection{An \afss-generated TOML Whitelist}

\begin{listing}[H]
  \caption{An example \afss-generated whitelist in TOML
  format. The whitelists take the format of \textit{shared object filename} to a
set of allowed system call numbers. This is the whitelist generated by
redis.}\label{lst:toml-whitelist}
  \begin{minted}[fontsize=\small, frame=single, linenos]{toml}
[files]
  "ld-linux-x86-64.so.2" = [9, 10, 11, 302]
  "libc.so.6" = [14, 273, 334]
  "libcap.so.2.66" = [157]
  "libcrypto.so.3" = [0, 3, 5, 39, 202, 257, 318]
  "libjemalloc.so.2" = [0, 2, 3, 9, 10, 11, 12, 14, 28, 89, 157, 202, 204, 435]
  "libstdc++.so.6.0.33" = [202]
  redis-check-rdb = [0, 1, 3, 5, 8, 9, 10, 13, 14, 15, ..., 435]
  \end{minted}
\end{listing}

\subsection{Raw data for privilege level calculations (\texttt{syso})}
\begin{listing}[H]
    \caption{An example data dump from the \texttt{syso} evaluation tool. As
    well as printing evaluation stats, \texttt{syso} also dumps the number of
times each syscall number was called.}\label{lst:syso-data-dump}
  \begin{minted}[fontsize=\small, frame=single, linenos]{json}
{
  "/home/tom/diss/addrfilter/bin/print": {
    "12": 2,
    "230": 9,
    "273": 1,
    "318": 1,
    "39": 1,
    "5": 1,
    "56": 1
  },
  "/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2": {
    "0": 1,
    "10": 3,
    "11": 1,
    "12": 1,
    "158": 1,
    "17": 2,
    "21": 1,
    "218": 1,
    "257": 2,
    "273": 1,
    "3": 2,
    "302": 1,
    "334": 1,
    "5": 2,
    "9": 8
  },
  "FAILED": {
    "13": 55,
    "14": 1,
    "160": 1,
    "292": 1,
    "59": 1,
    "72": 2
  }
}
  \end{minted}
\end{listing}

\subsection{Statistics which can be logged during \af program execution}
\begin{listing}[H]
    \caption{The stats enum that is used to index into the stats map. If
    \af exits early for any reason, one of these stats is logged and can be
  retrieved by userspace.}\label{lst:stat-enum}
  \begin{minted}[fontsize=\small, frame=single, linenos]{c}

  enum stat_type {
  GET_CUR_TASK_FAILED, /* when the bpf helper get_current_task fails */
  TP_ENTERED,          /* every time syscall is entered */
  GET_PROFILER_FAILED, /* ringbuf allocation for profiler failed */
  IGNORE_PID,          /* don't filter, PID isn't being traced */
  PID_READ_FAILED,     /* failed to read PID from current task */
  PPID_READ_FAILED,    /* failed to read PPID from current task */
  FOLLOW_FORK_FAILED,  /* failed to add a new element to protect_map */
  LIBC_NOT_LOADED,     /* Libc address space not loaded for current PID */
  STK_DBG_EMPTY,
  GET_STACK_FAILED, /* bpf_get_stack helper returned a non-0 error */
  CALLSITE_LIBC,    /* no non-libc call site could be found */
  STACK_TOO_SHORT, /* no non-libc call site could be found AND last read RP != 0
                    */
  NO_RP_MAPPING,   /* rp didn't come from mapped space */
  RP_NULL_AFTER_MAP, /* rp mapping failed silently (shouldn't happen!) */
  FILENAME_TOO_LONG, /* filename was longer than MAX_FILENAME_LEN characters */
  FIND_VMA_FAILED,   /* failed to find vma from rp */
  NO_VMA_BACKING_FILE,  /* RP was called from somewhere with no backing file */
  WHITELIST_MISSING,    /* no whitelist associated with memory address space
                           filename */
  SYSCALL_BLOCKED,      /* blocked a syscall */
  SEND_SIGNAL_FAILED,   /* bpf_send_signal returned non-zero value: backup kill
                           async*/
  KILLMODE_CFG_MISSING, /* no kill mode config set */
  WARN_FAILED_RINGBUF_FULL, /* warning userspace failed as ringbuf was full */
  STAT_END, /* not an event: used to autogenerate number of stat types for
               frontend */
};

#define N_STAT_TYPES STAT_END

\end{minted}
\end{listing}

\clearpage

\section{Validating \af Code Listings}\label{sec:linkage}

\subsection{getpid.h}
\begin{listing}[H] % Or [htbp] for floating placement
  \caption{Header file for \texttt{getpid} wrapper.}
    \label{lst:getpid-h}
    \inputminted[fontsize=\small, frame=single, linenos]{c}{./listings/linkage/getpid.h}
\end{listing}

\subsection{getpid.c}
\begin{listing}[H]
  \caption{Implementation file for \texttt{getpid} wrapper.}
    \label{lst:getpid-c}
    \inputminted[fontsize=\small, frame=single, linenos]{c}{./listings/linkage/getpid.c}
\end{listing}

\subsection{printf.h}
\begin{listing}[H]
  \caption{Header file for \texttt{printf} wrapper.}
    \label{lst:printf-h}
    \inputminted[fontsize=\small, frame=single, linenos]{c}{./listings/linkage/printf.h}
\end{listing}

\subsection{printf.c}
\begin{listing}[H]
  \caption{Implementation file for \texttt{printf} wrapper.}
    \label{lst:printf-c}
    \inputminted[fontsize=\small, frame=single, linenos]{c}{./listings/linkage/printf.c}
\end{listing}

\subsection{main.c}
\begin{listing}[H]
  \caption{Main program file which defines the \texttt{listing} executable.}
    \label{lst:main_c} % Note: You had this label twice, ensure labels are unique
    \inputminted[fontsize=\small, frame=single, linenos]{c}{./listings/linkage/main.c}
\end{listing}

% Optional: Include the assembly file if needed
% \subsection{linked.s}
% \begin{listing}[H]
%     \caption{Disassembled linked executable showing that no function inlining has taken place.}
%     \label{lst:linked-s}
%     % Use 'gas' for GNU assembler syntax, common on Linux. Use 'nasm' if appropriate.
%     \inputminted[fontsize=\small, frame=single, linenos]{gas}{./listings/linkage/main.s}
% \end{listing}

\subsection{linked-whitelist.toml}
\begin{listing}[H]
    \caption{Whitelist generated by the \texttt{afgen} when run on
    \texttt{./listing}.}
    \label{lst:whitelist-toml} % Ensure unique label
    \inputminted[fontsize=\small, frame=single, linenos]{toml}{./listings/linkage/linked-whitelist.toml}
\end{listing}

\clearpage

\section{Benchmarking and Profiling Results}

\subsection{Raw Data, Logs, and Generated Outputs}\label{apx:eval-artefacts}
Raw data from each experiment including log files and generated outputs are
available at
\href{https://github.com/tcassar-diss/evaluation-artefacts}{github.com/tcassar-diss/evaluation-artefacts}.

\subsection{An Excerpt From A Profile of a ``Hello, World'' Application}

\begin{table}[H]
  \centering
\scalebox{0.8}{%
  \begin{tabular}{rrrrrr}
    \hline
    \texttt{get-pid} & \texttt{apply-filter} & \texttt{find-syscall-site} &
    \texttt{assign-filename} &
    \texttt{assoc-whitelist} & \texttt{perform-filtering} \\
    \hline
    964 & 1031  & 7114   & 2061 & 1295  & 0 \\
    339 & 487   & 3719   & 875  & 660   & 0 \\
    762 & 2511  & 6698   & 1497 & 1043  & 0 \\
    517 & 762   & 2921   & 855  & 653   & 0 \\
    357 & 1073  & 6219   & 1684 & 1037  & 0 \\
    247 & 401   & 2965   & 541  & 628   & 0 \\
    352 & 2391  & 5995   & 1608 & 1019  & 0 \\
    336 & 580   & 2681   & 574  & 601   & 0 \\
    674 & 765   & 5382   & 1680 & 926   & 0 \\
    340 & 351   & 2662   & 588  & 625   & 0 \\
    401 & 1954  & 5330   & 1658 & 872   & 0 \\
    224 & 551   & 2793   & 696  & 596   & 0 \\
    649 & 798   & 24348  & 1856 & 959   & 0 \\
    337 & 1935  & 5467   & 1719 & 858   & 0 \\
    214 & 616   & 2951   & 697  & 678   & 0 \\
    344 & 566   & 2687   & 537  & 608   & 0 \\
    339 & 1907  & 5391   & 1693 & 850   & 0 \\
    341 & 852   & 5337   & 1684 & 929   & 0 \\
    206 & 712   & 2645   & 663  & 612   & 0 \\
    190 & 463   & 2662   & 578  & 625   & 0 \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    \hline
  \end{tabular}
  }
  \caption{An excerpt from a profile generated by \af (after optimisation) of a ``hello, world''
  application. A kernel timestamp is recorded after each stage, and a diff is
taken. perform-filtering is 0 as no syscalls were filtered during this run.}
  \label{tab:profile-info}
\end{table}


\subsection{Nginx Configuration Files}\label{subsec:nginx}

\subsubsection{\texttt{nginx.conf}}
\begin{listing}[H]
  \caption{Nginx config file used for evaluation \af.}
    \label{lst:nginx-conf}
    \inputminted[fontsize=\small, frame=single,
    linenos]{python}{./listings/nginx/nginx_bench/nginx.conf}
\end{listing}

\subsubsection{\texttt{index.html}}
\begin{listing}[H]
  \caption{Small static site we served from Nginx during evaluation}
    \label{lst:index-html}
    \inputminted[fontsize=\small, frame=single,
    linenos]{html}{./listings/nginx/nginx_bench/html/index.html}
\end{listing}

\subsection{\acs{npb} Configuration Files}\label{subsec:npb}

\subsubsection{\texttt{make.def}}
\begin{listing}[H]
  \caption{\ac{npb} configuration file which defines build environments for C
  and Fortran}
    \label{lst:npb-make-def}
    \inputminted[fontsize=\small, frame=single,
    linenos]{make}{./listings/nbp/make.def}
\end{listing}

\subsubsection{\texttt{suite.def}}
\begin{listing}[H]
  \caption{\ac{npb} configuration file specifying the workload size to use for
  each microbenchmark.}
    \label{lst:npb-suite-def}
    \inputminted[fontsize=\small, frame=single,
    linenos]{text}{./listings/nbp/suite.def}
\end{listing}


\section{Profiling Flame Graphs}\label{apx:flame-graphs}

\subsection{Postgres}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{./evaluation-artefacts/results/profiling/postgres-prof_time_breakdown_sampled_clipped.pdf}
    \caption{A stacked bar chart showing the profile of Postgres (in nanoseconds) \af
    spent in each phase of filtering.}
    \label{fig:postgres-profile}
\end{figure}


\subsection{Redis}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{./evaluation-artefacts/results/profiling/redis-server-prof_time_breakdown_sampled_clipped.pdf}
    \caption{A stacked bar chart showing the profile of Redis (in nanoseconds) \af
    spent in each phase of filtering.}
    \label{fig:redis-profile}
\end{figure}


\subsection{Nginx}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{./evaluation-artefacts/results/profiling/nginx-prof_time_breakdown_clipped.pdf}
    \caption{A stacked bar chart showing the profile of Nginx (in nanoseconds) \af
    spent in each phase of filtering.}
    \label{fig:nginx-profile}
\end{figure}

\subsection{\texttt{fio}}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{./evaluation-artefacts/results/profiling/fio-prof_time_breakdown_sampled_clipped.pdf}
    \caption{A stacked bar chart showing the profile of \texttt{fio} (in nanoseconds) \af
    spent in each phase of filtering.}
    \label{fig:fio-profile}
\end{figure}

\subsection{NPB (./bt.C.x)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{./evaluation-artefacts/results/profiling/bt.C.x-prof_time_breakdown_sampled_clipped.pdf}
    \caption{A stacked bar chart showing the profile of ./bt.C.x microbenchmark
      from \ac{npb} (in nanoseconds) \af
    spent in each phase of filtering.}
    \label{fig:npb-profile}
\end{figure}

