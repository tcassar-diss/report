\appendix
\section{Code Samples}


\subsection{An \afss-generated TOML Whitelist}

\begin{listing}[H]
  \caption{An example \afss-generated whitelist in TOML
  format. The whitelists take the format of \textit{shared object filename} to a
set of allowed system call numbers.}\label{lst:toml-whitelist}
  \begin{minted}[fontsize=\small, frame=single, linenos]{toml}
[files]
"print" = [5, 12, 39, 56, 230, 273, 318]  # main binary
"ld-linux-x86-64.so.2" = [0, 3, 5, 9, 10, 11, 12, 17, 21, 158, 218, 257,
    273, 302, 334] # the linker
  \end{minted}
\end{listing}

\subsection{Raw data for privilege level calculations (\texttt{syso})}
\begin{listing}[H]
    \caption{An example data dump from the \texttt{syso} evaluation tool. As
    well as printing evaluation stats, \texttt{syso} also dumps the number of
times each syscall number was called.}\label{lst:syso-data-dump}
  \begin{minted}[fontsize=\small, frame=single, linenos]{json}
{
  "/home/tom/diss/addrfilter/bin/print": {
    "12": 2,
    "230": 9,
    "273": 1,
    "318": 1,
    "39": 1,
    "5": 1,
    "56": 1
  },
  "/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2": {
    "0": 1,
    "10": 3,
    "11": 1,
    "12": 1,
    "158": 1,
    "17": 2,
    "21": 1,
    "218": 1,
    "257": 2,
    "273": 1,
    "3": 2,
    "302": 1,
    "334": 1,
    "5": 2,
    "9": 8
  },
  "FAILED": {
    "13": 55,
    "14": 1,
    "160": 1,
    "292": 1,
    "59": 1,
    "72": 2
  }
}
  \end{minted}
\end{listing}

\subsection{Statistics which can be logged during \af program execution}
\begin{listing}[H]
    \caption{The stats enum that is used to index into the stats map. If
    \af exits early for any reason, one of these stats is logged and can be
  retrieved by userspace.}\label{lst:stat-enum}
  \begin{minted}[fontsize=\small, frame=single, linenos]{c}

  enum stat_type {
  GET_CUR_TASK_FAILED, /* when the bpf helper get_current_task fails */
  TP_ENTERED,          /* every time syscall is entered */
  GET_PROFILER_FAILED, /* ringbuf allocation for profiler failed */
  IGNORE_PID,          /* don't filter, PID isn't being traced */
  PID_READ_FAILED,     /* failed to read PID from current task */
  PPID_READ_FAILED,    /* failed to read PPID from current task */
  FOLLOW_FORK_FAILED,  /* failed to add a new element to protect_map */
  LIBC_NOT_LOADED,     /* Libc address space not loaded for current PID */
  STK_DBG_EMPTY,
  GET_STACK_FAILED, /* bpf_get_stack helper returned a non-0 error */
  CALLSITE_LIBC,    /* no non-libc call site could be found */
  STACK_TOO_SHORT, /* no non-libc call site could be found AND last read RP != 0
                    */
  NO_RP_MAPPING,   /* rp didn't come from mapped space */
  RP_NULL_AFTER_MAP, /* rp mapping failed silently (shouldn't happen!) */
  FILENAME_TOO_LONG, /* filename was longer than MAX_FILENAME_LEN characters */
  FIND_VMA_FAILED,   /* failed to find vma from rp */
  NO_VMA_BACKING_FILE,  /* RP was called from somewhere with no backing file */
  WHITELIST_MISSING,    /* no whitelist associated with memory address space
                           filename */
  SYSCALL_BLOCKED,      /* blocked a syscall */
  SEND_SIGNAL_FAILED,   /* bpf_send_signal returned non-zero value: backup kill
                           async*/
  KILLMODE_CFG_MISSING, /* no kill mode config set */
  WARN_FAILED_RINGBUF_FULL, /* warning userspace failed as ringbuf was full */
  STAT_END, /* not an event: used to autogenerate number of stat types for
               frontend */
};

#define N_STAT_TYPES STAT_END

\end{minted}
\end{listing}

\subsection{An Excerpt From A Profile of a ``Hello, World'' Application}

\begin{table}[H]
  \centering
\scalebox{0.8}{%
  \begin{tabular}{rrrrrr}
    \hline
    \texttt{get-pid} & \texttt{apply-filter} & \texttt{find-syscall-site} &
    \texttt{assign-filename} &
    \texttt{assoc-whitelist} & \texttt{perform-filtering} \\
    \hline
    964 & 1031  & 7114   & 2061 & 1295  & 0 \\
    339 & 487   & 3719   & 875  & 660   & 0 \\
    762 & 2511  & 6698   & 1497 & 1043  & 0 \\
    517 & 762   & 2921   & 855  & 653   & 0 \\
    357 & 1073  & 6219   & 1684 & 1037  & 0 \\
    247 & 401   & 2965   & 541  & 628   & 0 \\
    352 & 2391  & 5995   & 1608 & 1019  & 0 \\
    336 & 580   & 2681   & 574  & 601   & 0 \\
    674 & 765   & 5382   & 1680 & 926   & 0 \\
    340 & 351   & 2662   & 588  & 625   & 0 \\
    401 & 1954  & 5330   & 1658 & 872   & 0 \\
    224 & 551   & 2793   & 696  & 596   & 0 \\
    649 & 798   & 24348  & 1856 & 959   & 0 \\
    337 & 1935  & 5467   & 1719 & 858   & 0 \\
    214 & 616   & 2951   & 697  & 678   & 0 \\
    344 & 566   & 2687   & 537  & 608   & 0 \\
    339 & 1907  & 5391   & 1693 & 850   & 0 \\
    341 & 852   & 5337   & 1684 & 929   & 0 \\
    206 & 712   & 2645   & 663  & 612   & 0 \\
    190 & 463   & 2662   & 578  & 625   & 0 \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    \hline
  \end{tabular}
  }
  \caption{An excerpt from a profile generated by \af (after optimisation) of a ``hello, world''
  application. A kernel timestamp is recorded after each stage, and a diff is
taken. perform-filtering is 0 as no syscalls were filtered during this run.}
  \label{tab:profile-info}
\end{table}

